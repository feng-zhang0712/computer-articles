# TCP 的运输连接管理

## 介绍

TCP（Transmission Control Protocol，传输控制协议）是一种面向连接的协议，它在通信双方之间建立可靠的连接，以确保数据的有序、无差错传输。TCP 的连接使用 **三次握手** 机制，TCP 连接的释放使用 **四次挥手** 机制。

在 TCP 连接建立过程中，要解决三个问题：

1. 要使每一方都能够知道对方的存在。
2. 要允许双方协商一些参数。
3. 能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配。

## TCP 的连接建立

TCP 在客户端和服务器端建立连接的过程称为三次握手。以下是三次握手过程的示例图。

![TCP 的三次握手过程](/assets/tcp-three-way-handshake.png)
*图片来自 《计算机网络（第七版）》*

整个连接建立的过程是这样：

1. 在连接开始之前，客户端和服务器都处于 CLOSED（关闭）状态，此时，服务器处于 LISTEN（收听）状态。
2. 客户端向服务器发出连接请求报文段，表示希望建立连接（报文格式如下所示）。此时，客户端进入 SYN-SENT（同步已发送）状态。

    ```plaintext
    SYN = 1, seq = x
    ```

3. 服务器收到连接请求报文段后，如果同意建立连接，则向客户端发送确认（确认报文格式如下所示）。此时，服务器处于 SYN-RCVD（同步已收到）状态。

    ```plaintext
    SYN = 1, ACK = 1, seq = y, ack = x + 1
    ```

4. 客户端收到服务器的确认后，还要向服务器发送一个确认报文（确认报文格式如下所示）。此时，TCP 连接已经建立，客户端进入 ESTABLISHED（已建立连接） 状态。服务器收到客户端的确认后，也进入 ESTABLISHED 状态。

    ```plaintext
    ACK = 1, seq = x + 1, ack = y + 1
    ```

上面的过程中，客户端最后又发送了一次确认，原因是为了防止 **已失效的连接请求，突然又传到了服务器，因而产生错误**。

这里所说的 **已失效的连接请求**， 是指这样一种情况。举例来说，客户端刚发送了一次连接请求 A，但是由于种种原因，A 在网络中的某个节点被滞留了，以致延误到连接释放以后的某个时间节点才到达服务器。此时，A 请求应该被认定为失效的请求，但之后 A 请求到达了服务器，服务器认为客户端又发出了一次连接请求，于是，服务器向客户端发出确认报文，同意建立连接。如果没有第三次握手，那么此时新的连接就已经建立了。

然而，实际的情况是，客户端并没有发出连接请求，所以，客户端会忽略服务器的确认报文，也就不会向服务器发送数据。但服务器认为连接已经建立，会等待客户端发送数据，这样，就造成了服务器资源的浪费。

采用三次握手，就可以防止上述情况的发生。也就是上边的例子中，客户端不会向服务器的确认发送确认报文。由于服务器没有收到客户端的确认报文，也就知道了，客户端并没有要求建立连接。

<!-- ### 5. 常见问题及处理

#### 5.1 SYN 洪泛攻击

SYN 洪泛攻击（SYN Flood Attack）是利用 TCP 三次握手过程中的漏洞进行的拒绝服务攻击。攻击者发送大量伪造的 SYN 报文，使服务器创建大量半连接，耗尽服务器资源。

- **防御方法**：
  - **SYN Cookies**：在服务器生成 SYN-ACK 报文时，不立即分配资源，而是通过加密算法生成一个 Cookie 作为 ACK 报文的一部分。客户端在第三次握手时，发送包含此 Cookie 的 ACK 报文，服务器验证后才分配资源。
  - **缩短 SYN-RECEIVED 超时时间**：减少服务器保持半连接状态的时间，尽快释放资源。
  - **限制每个 IP 的连接数**：防止单个 IP 发送大量 SYN 报文。

### 6. 三次握手与四次挥手的对比

在 TCP 协议中，连接的建立通过三次握手完成，而连接的释放通过四次挥手（Four-Way Handshake）完成。四次挥手的过程如下：

- **第一次挥手**：客户端发送 FIN 报文，表示不再发送数据，但仍可接收数据。
- **第二次挥手**：服务器收到 FIN 报文，发送 ACK 报文，确认已收到客户端的 FIN 报文。
- **第三次挥手**：服务器发送 FIN 报文，表示不再发送数据，但可接收数据。
- **第四次挥手**：客户端收到服务器的 FIN 报文，发送 ACK 报文，确认已收到服务器的 FIN 报文。

三次握手用于连接的建立，而四次挥手用于连接的释放，两者共同确保 TCP 连接的可靠性和有序性。 -->

## TCP 的连接释放

四次挥手（Four-Way Handshake）是 TCP 协议中用于终止连接的过程。它包括四个步骤，确保客户端和服务器双方都能正确地终止连接，并且确认对方已准备好断开连接。以下是四次挥手过程的示例图。

![TCP 的四次挥手过程](/assets/tcp-four-way-handshake.png)
*图片来自 《计算机网络（第七版）》*



























#



### 2. 四次挥手的过程

#### 2.1 初始状态

- **客户端**：准备断开 TCP 连接，处于 ESTABLISHED 状态。
- **服务器**：与客户端保持连接，处于 ESTABLISHED 状态。

#### 2.2 第一次挥手（FIN）

- **客户端**：向服务器发送一个 FIN（Finish）报文，表示希望终止连接。这时，客户端进入 FIN-WAIT-1 状态。
- **报文内容**：FIN 标志位置为 1，包含当前序列号（Sequence Number, 简称 SEQ）。

```plaintext
客户端 -> 服务器: FIN=1, SEQ=X
```

#### 2.3 第二次挥手（ACK）

- **服务器**：收到客户端的 FIN 报文后，向客户端发送一个确认报文（ACK），确认已收到客户端的 FIN 报文。这时，服务器进入 CLOSE-WAIT 状态。
- **报文内容**：ACK 标志位置为 1，ACK=X+1。

```plaintext
服务器 -> 客户端: ACK=1, ACK=X+1
```

- **客户端**：收到服务器的 ACK 报文后，进入 FIN-WAIT-2 状态，等待服务器发送 FIN 报文。

#### 2.4 第三次挥手（FIN）

- **服务器**：向客户端发送一个 FIN 报文，表示希望终止连接。这时，服务器进入 LAST-ACK 状态。
- **报文内容**：FIN 标志位置为 1，包含当前序列号（SEQ=Y）。

```plaintext
服务器 -> 客户端: FIN=1, SEQ=Y
```

#### 2.5 第四次挥手（ACK）

- **客户端**：收到服务器的 FIN 报文后，向服务器发送一个确认报文（ACK），确认已收到服务器的 FIN 报文。这时，客户端进入 TIME-WAIT 状态。
- **报文内容**：ACK 标志位置为 1，ACK=Y+1。

```plaintext
客户端 -> 服务器: ACK=1, ACK=Y+1
```

- **服务器**：收到客户端的 ACK 报文后，进入 CLOSED 状态，连接正式关闭。

- **客户端**：在 TIME-WAIT 状态等待一段时间（通常为 2 倍的最大报文生存时间，MSL）后，进入 CLOSED 状态，连接正式关闭。

### 3. 四次挥手的示意图

```plaintext
客户端          服务器
  |                |
  |   FIN=1, SEQ=X  |  -> 第一次挥手
  | --------------> |
  |                |
  |   ACK=1, ACK=X+1  |  <- 第二次挥手
  | <-------------- |
  |                |
  |   FIN=1, SEQ=Y  |  -> 第三次挥手
  | <-------------- |
  |                |
  |   ACK=1, ACK=Y+1  |  -> 第四次挥手
  | --------------> |
  |                |
```

### 4. 四次挥手的意义

四次挥手的主要目的是为了在客户端和服务器之间可靠地关闭连接，并确保双方的所有数据都已成功传输：

- **第一次挥手**：客户端向服务器发送连接终止请求。
- **第二次挥手**：服务器确认客户端的终止请求。
- **第三次挥手**：服务器向客户端发送连接终止请求。
- **第四次挥手**：客户端确认服务器的终止请求。

通过四次挥手，客户端和服务器都能确认对方已准备好断开连接，从而安全地关闭 TCP 连接。

### 5. TIME-WAIT 状态

在四次挥手过程中，客户端在发送完第四次握手的 ACK 报文后进入 TIME-WAIT 状态。该状态的主要目的是：

- **确保最后一个 ACK 报文能够到达服务器**：如果服务器没有收到最后的 ACK 报文，它会重传 FIN 报文，而客户端在 TIME-WAIT 状态可以重新发送 ACK 报文。
- **防止旧连接的数据影响新连接**：在 TIME-WAIT 状态，确保旧连接中的所有报文在网络中消失，避免影响同一端口的新连接。

TIME-WAIT 状态通常持续 2 倍的最大报文生存时间（MSL），即等待这段时间后，客户端会彻底关闭连接。

### 6. 常见问题及处理

#### 6.1 TIME-WAIT 状态过多

在高并发的网络服务中，大量的 TIME-WAIT 状态可能会耗尽系统资源。

- **优化方法**：
  - **增加端口范围**：增加系统可用的临时端口范围，减少端口耗尽的概率。
  - **缩短 TIME-WAIT 超时时间**：在操作系统中配置缩短 TIME-WAIT 状态的持续时间（仅在确保网络环境稳定的情况下进行）。
  - **复用端口**：启用端口复用选项，使得在 TIME-WAIT 状态可以复用端口（如设置 `SO_REUSEADDR` 选项）。

#### 6.2 半关闭状态

在四次挥手过程中，服务器在发送 FIN 报文之前可能会继续发送数据，而客户端需要继续接收这些数据。这种状态称为半关闭状态。

- **处理方法**：
  - **正确处理半关闭状态**：确保在连接关闭之前，所有数据都已成功传输。
  - **使用双工关闭**：在某些情况下，可以通过应用层协议处理双工关闭，即双方同时发送 FIN 报文。

通过正确理解 TCP 的四次挥手机制，开发者可以更好地管理网络连接，确保数据传输的可靠性和安全性。



